<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>SafePal å……å€¼åŠ©æ‰‹ (æ— ç—•ç‰ˆ)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --card-highlight:#334155;
      --text:#f1f5f9; --muted:#94a3b8; --border:rgba(255,255,255,0.1);
      --accent:#3b82f6; --accent-hover:#2563eb;
      --gold:#fbbf24; --green:#10b981; --red:#ef4444;
      --radius:16px;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --font-sans: ui-sans-serif, system-ui, -apple-system, sans-serif;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{
      margin:0; font-family:var(--font-sans); 
      background:var(--bg); color:var(--text);
      padding:20px; line-height:1.5; padding-bottom:40px;
    }
    .wrap{max-width:1000px; margin:0 auto;}
    
    header{margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px;}
    h1{margin:0 0 6px; font-size:20px; color:#fff; display:flex; align-items:center; gap:8px;}
    .badge{font-size:10px; padding:2px 6px; border-radius:4px; background:rgba(255,255,255,0.1); color:var(--muted); border:1px solid var(--border);}
    .pill{display:inline-block; font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted); border:1px solid var(--border);}

    .grid{display:grid; grid-template-columns: 1.1fr 0.9fr; gap:20px;}
    @media (max-width: 800px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.2);}
    .card-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;}
    .card-title{font-size:15px; font-weight:600; color:#fff;}
    .btn-reset{font-size:11px; padding:4px 10px; background:transparent; border:1px solid var(--border); color:var(--muted); border-radius:6px; cursor:pointer;}
    
    .step-title{
      font-size:11px; text-transform:uppercase; letter-spacing:1px; font-weight:700;
      color:var(--muted); margin:20px 0 10px; display:flex; align-items:center; gap:8px;
    }
    .step-num{background:var(--card-highlight); color:#fff; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px;}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;}
    .row:last-child{margin-bottom:0;}
    
    .input-group label{display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); margin-bottom:6px;}
    
    .lock-icon{cursor:pointer; opacity:0.6; transition:all 0.2s; padding:2px 6px; border-radius:4px;}
    .lock-icon:hover{opacity:1; background:rgba(255,255,255,0.1);}
    
    input[type="number"]{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--border);
      background:#0f172a; color:#fff; font-family:var(--font-mono); font-size:15px;
      transition:all 0.2s;
    }
    input:focus{outline:none; border-color:var(--accent);}
    input[readonly]{background:rgba(255,255,255,0.02); color:rgba(255,255,255,0.4); border-color:transparent; cursor:default;}
    
    .hint{font-size:11px; color:var(--muted); margin-top:4px; opacity:0.6;}

    .hero{
      background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.02));
      border:1px solid rgba(59,130,246,0.25); border-radius:12px; padding:24px; text-align:center;
      margin-bottom:20px; transition:all 0.3s;
    }
    .hero.success{background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.02)); border-color:rgba(16,185,129,0.3);}
    
    .hero h3{margin:0; font-size:12px; color:var(--accent); text-transform:uppercase; letter-spacing:1px;}
    .hero.success h3{color:var(--green);}
    
    .hero .val{font-size:36px; font-family:var(--font-mono); font-weight:700; color:#fff; margin:10px 0;}
    .hero .tag{font-size:12px; color:var(--muted); background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:20px;}

    .alert{
      display:none; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3);
      color:var(--red); padding:12px; border-radius:8px; font-size:13px; margin-bottom:16px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

    .list{display:grid; gap:0;}
    .list-item{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);}
    .list-item:last-child{border-bottom:none;}
    .list-item span:first-child{font-size:13px; color:var(--muted);}
    .list-item span:last-child{font-family:var(--font-mono); font-size:14px; color:#e2e8f0;}

    .check-area{margin:20px 0 16px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px dashed var(--border);}
    .check-label{display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer; user-select:none;}
    .check-label input{accent-color:var(--accent); width:16px; height:16px;}
    
    .btn-main{
      width:100%; padding:14px; border:none; border-radius:10px; 
      background:var(--accent); color:#fff; font-weight:600; font-size:15px; cursor:pointer;
      box-shadow:0 4px 12px rgba(59,130,246,0.3); transition:transform 0.1s;
    }
    .btn-main:active{transform:scale(0.98);}
    
    .btn-copy{
      width:100%; margin-top:12px; padding:12px; background:transparent; 
      border:1px solid var(--border); color:var(--muted); border-radius:10px; cursor:pointer; font-size:13px;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .btn-copy:hover{border-color:var(--accent); color:var(--accent);}

    .c-gold{color:var(--gold)}
    .c-green{color:var(--green)}
    .c-red{color:var(--red)}
    .hidden{display:none !important;}
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>SafePal å……å€¼åŠ©æ‰‹ <span class="badge">æ— ç—•ç‰ˆ</span></h1>
    <div class="pill">USDT â†’ USDC (Arb) â†’ SafePal Bank</div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="card-head">
        <div class="card-title">å‚æ•°é…ç½®</div>
        <button class="btn-reset" id="btnReset">é‡ç½®é»˜è®¤</button>
      </div>

      <div class="step-title"><span class="step-num">1</span> é’±åŒ…çŠ¶æ€ (SafePal)</div>
      <div class="row">
        <div class="input-group">
          <label>å½“å‰ USD ä½™é¢</label>
          <input id="usdBalance" type="number" step="0.01" value="0.00" placeholder="0.00" autocomplete="off" />
        </div>
        <div class="input-group">
          <label>ç›®æ ‡ USD é‡‘é¢</label>
          <input id="usdTarget" type="number" step="0.01" value="20.01" autocomplete="off" />
        </div>
      </div>

      <div class="step-title"><span class="step-num">2</span> æŸè€—ä¸ä¿é™© (Fees)</div>
      <div class="row">
        <div class="input-group">
          <label>å¸å®‰æç°è´¹ (USDC)</label>
          <input id="withdrawFee" type="number" value="0.24" autocomplete="off" />
          <div class="hint">Arbitrum ç½‘ç»œ</div>
        </div>
        <div class="input-group">
          <label>
            SP åˆ°è´¦æ¯”ä¾‹
            <span class="lock-icon" data-target="safepalRatio" title="è§£é”">ğŸ”’</span>
          </label>
          <input id="safepalRatio" type="number" value="0.99" readonly autocomplete="off" />
        </div>
      </div>
      <div class="row">
        <div class="input-group">
          <label>
            æˆªæ–­ä¿é™© (USD)
            <span class="lock-icon" data-target="truncIns" title="è§£é”">ğŸ”’</span>
          </label>
          <input id="truncIns" type="number" step="0.01" value="0.01" readonly autocomplete="off" />
        </div>
        <div class="input-group">
          <label>
            C2C å†—ä½™ (USDT)
            <span class="lock-icon" data-target="extraIns" title="è§£é”">ğŸ”’</span>
          </label>
          <input id="extraIns" type="number" step="0.01" value="0.02" readonly autocomplete="off" />
        </div>
      </div>

      <div class="step-title"><span class="step-num">3</span> æ±‡ç‡ (Binance)</div>
      <div class="row">
        <div class="input-group">
          <label>é—ªå…‘ä»˜å‡º USDT</label>
          <input id="swapPayUsdt" type="number" value="1000" autocomplete="off" />
        </div>
        <div class="input-group">
          <label>é—ªå…‘æ”¶åˆ° USDC</label>
          <input id="swapGetUsdc" type="number" value="1001.00" autocomplete="off" />
          <div class="hint" id="kVal">k â‰ˆ 1.001</div>
        </div>
      </div>
      <div class="row">
        <div class="input-group" style="grid-column: span 2;">
          <label>USDT å‚è€ƒä»· (CNY)</label>
          <input id="cnyPrice" type="number" step="0.01" value="7.40" placeholder="ä¾‹å¦‚ 7.35" autocomplete="off" />
          <div class="hint">ç”¨äºé¢„ä¼°äººæ°‘å¸æ”¯å‡º</div>
        </div>
      </div>

      <div class="check-area">
        <label class="check-label">
          <input type="checkbox" id="hasGas" checked>
          <span>ç¡®è®¤ï¼šé’±åŒ…å·²æœ‰ ETH (Arb) åš Gas</span>
        </label>
        <div id="gasWarning" style="display:none; color:var(--gold); font-size:12px; margin-top:8px; padding-left:26px;">
          âš ï¸ å¿…é¡»æœ‰ ETH æ‰èƒ½å……å€¼ï¼Œå¦åˆ™èµ„é‡‘ä¼šå¡åœ¨é’±åŒ…é‡Œã€‚
        </div>
      </div>

      <button class="btn-main" id="btnCalc">è®¡ç®—è´­ä¹°æ–¹æ¡ˆ</button>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-title">æ‰§è¡Œæ–¹æ¡ˆ</div>
      </div>

      <div class="hero" id="heroCard">
        <h3 id="heroTitle">å»ºè®® C2C è´­ä¹° (USDT)</h3>
        <div class="val" id="resFinalUSDT">â€”</div>
        <div class="tag" id="resFinalTag">å«æŸè€—+ä¿é™©</div>
        <div style="margin-top:10px; font-size:13px; color:var(--muted); border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
          é¢„ä¼°æ”¯å‡º: <span style="color:#fff; font-weight:700;">â‰ˆ Â¥<span id="resEstCNY">0.00</span></span>
        </div>
      </div>

      <div class="alert" id="limitAlert">
        <strong>âš ï¸ é—¨æ§›è­¦å‘Š</strong><br/>
        è¡¥æ¬¾é¢ < 10 USDCï¼ŒSafePal æˆ–å¸å®‰å¯èƒ½æ‹’ç»å¤„ç†ã€‚å»ºè®®ç›´æ¥å…… 10 USDCã€‚
      </div>

      <div class="list" id="resultList">
        <div class="list-item">
          <span>éœ€è¡¥è¶³ USD</span>
          <span id="resNeedUSD">â€”</span>
        </div>
        <div class="list-item">
          <span>SafePal å……å€¼ (USDC)</span>
          <span id="resTopupUSDC" class="c-gold">â€”</span>
        </div>
        <div class="list-item">
          <span>å¸å®‰æç° (USDC)</span>
          <span id="resWithdraw">â€”</span>
        </div>
        <div class="list-item">
          <span>é¢„æµ‹æœ€ç»ˆä½™é¢</span>
          <span id="resEndBalance" class="c-green">â€”</span>
        </div>
      </div>

      <button class="btn-copy" id="btnCopy">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        å¤åˆ¶æ¸…å•
      </button>
      <div id="copyMsg" style="text-align:center; font-size:12px; color:var(--green); height:20px; margin-top:5px;"></div>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmt = (n, d=2) => Number(n).toFixed(d);
  const ceil2 = n => Math.ceil(n * 100) / 100;
  const floor2 = n => Math.floor(n * 100) / 100;

  function calc() {
    // 1. è¯»å–åŸºç¡€å‚æ•°
    const B = parseFloat($("#usdBalance").value) || 0;
    const T = parseFloat($("#usdTarget").value) || 20.01;
    const fee = parseFloat($("#withdrawFee").value) || 0;
    const cnyRate = parseFloat($("#cnyPrice").value) || 0;
    
    // é«˜çº§å‚æ•°
    const ratio = parseFloat($("#safepalRatio").value) || 0.99;
    const truncIns = parseFloat($("#truncIns").value) || 0.01;
    const extraIns = parseFloat($("#extraIns").value) || 0.02;

    // é—ªå…‘æ±‡ç‡
    const pay = parseFloat($("#swapPayUsdt").value) || 1;
    const get = parseFloat($("#swapGetUsdc").value) || 1;
    const k = (pay > 0) ? get / pay : 1;
    $("#kVal").innerText = `k â‰ˆ ${k.toFixed(5)}`;

    // 2. é€»è¾‘åˆ¤æ–­
    const needUSD = Math.max(0, T - B);
    const heroCard = $("#heroCard");
    const resultList = $("#resultList");
    const limitAlert = $("#limitAlert");

    if (needUSD <= 0) {
      // --- èµ„é‡‘å……è¶³ ---
      heroCard.classList.add("success");
      $("#heroTitle").innerText = "æ— éœ€æ“ä½œ";
      $("#resFinalUSDT").innerText = "èµ„é‡‘å……è¶³";
      $("#resFinalTag").innerText = "ä½™é¢ â‰¥ ç›®æ ‡";
      $("#resEstCNY").innerText = "0.00";
      
      limitAlert.style.display = "none";
      resultList.style.opacity = "0.5";
      
      $("#resNeedUSD").innerText = "0.00";
      $("#resTopupUSDC").innerText = "0.0000";
      $("#resWithdraw").innerText = "0.0000";
      $("#resEndBalance").innerText = fmt(B);
      
      return; 
    }

    // --- æ­£å¸¸è®¡ç®— ---
    heroCard.classList.remove("success");
    $("#heroTitle").innerText = "å»ºè®® C2C è´­ä¹° (USDT)";
    resultList.style.opacity = "1";

    let topupUSDC = (needUSD + truncIns) / ratio;
    const withdrawInput = topupUSDC + fee;
    const needRaw = withdrawInput / k;
    const finalUSDT = ceil2(needRaw + extraIns);
    const estCNY = finalUSDT * cnyRate;
    const predictCredit = floor2(topupUSDC * ratio);
    const endBal = B + predictCredit;

    $("#resNeedUSD").innerText = fmt(needUSD);
    $("#resTopupUSDC").innerText = fmt(topupUSDC, 4);
    $("#resWithdraw").innerText = fmt(withdrawInput, 4);
    $("#resEndBalance").innerText = fmt(endBal);
    $("#resFinalUSDT").innerText = fmt(finalUSDT);
    $("#resFinalTag").innerText = "å«æŸè€—+ä¿é™©";
    $("#resEstCNY").innerText = fmt(estCNY);

    const topupEl = $("#resTopupUSDC");
    if(topupUSDC < 10) {
      limitAlert.style.display = "block";
      topupEl.classList.add("c-red");
      topupEl.classList.remove("c-gold");
    } else {
      limitAlert.style.display = "none";
      topupEl.classList.remove("c-red");
      topupEl.classList.add("c-gold");
    }
    // æ— ç—•æ¨¡å¼ï¼šè®¡ç®—å®Œä¸ä¿å­˜
  }

  // --- äº¤äº’é€»è¾‘ ---
  
  // é”æ§åˆ¶
  $$('.lock-icon').forEach(icon => {
    icon.addEventListener('click', (e) => {
      const targetId = e.target.dataset.target;
      const input = $("#" + targetId);
      const isLocked = input.hasAttribute("readonly");
      
      if(isLocked) {
        input.removeAttribute("readonly");
        e.target.innerText = "ğŸ”“";
        input.focus();
      } else {
        input.setAttribute("readonly", true);
        e.target.innerText = "ğŸ”’";
      }
    });
  });

  // Gas è­¦å‘Š
  $("#hasGas").addEventListener("change", (e) => {
    $("#gasWarning").style.display = e.target.checked ? "none" : "block";
  });

  // å¤åˆ¶åŠŸèƒ½
  $("#btnCopy").addEventListener("click", () => {
    const now = new Date();
    const timeStr = `${now.getMonth()+1}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
    
    const txt = `[SafePalå……å€¼å•] ${timeStr}\n----------------\néœ€è¡¥: ${$("#resNeedUSD").innerText} USD\nå½“å‰ä½™é¢: ${$("#usdBalance").value}\n----------------\n1. é—ªå…‘å‚è€ƒ: ${$("#kVal").innerText}\n2. C2Cè´­ä¹°: ${$("#resFinalUSDT").innerText} USDT (â‰ˆÂ¥${$("#resEstCNY").innerText})\n3. æç°è¾“å…¥: ${$("#resWithdraw").innerText} USDC\n----------------\né¢„æµ‹ä½™é¢: ${$("#resEndBalance").innerText}`;
    
    navigator.clipboard.writeText(txt).then(() => {
      $("#copyMsg").innerText = "âœ… å·²å¤åˆ¶";
      setTimeout(()=>$("#copyMsg").innerText="", 2000);
    });
  });

  function lockAll() {
    ["safepalRatio", "truncIns", "extraIns"].forEach(id => {
      $("#"+id).setAttribute("readonly", true);
      $(`.lock-icon[data-target="${id}"]`).innerText = "ğŸ”’";
    });
  }

  $("#btnReset").addEventListener("click", () => {
    // æ¢å¤æ‰€æœ‰é»˜è®¤å€¼
    $("#usdBalance").value = "0.00";
    $("#usdTarget").value = "20.01";
    $("#withdrawFee").value = "0.24";
    $("#cnyPrice").value = "7.40";
    
    $("#safepalRatio").value = "0.99";
    $("#truncIns").value = "0.01";
    $("#extraIns").value = "0.02";
    
    lockAll();
    calc();
  });

  // ç›‘å¬è¾“å…¥
  document.querySelectorAll("input").forEach(el => el.addEventListener("input", calc));
  
  // åˆå§‹åŒ– (ä»…è¿è¡Œè®¡ç®—ï¼Œä¸è¯»å–localStorage)
  calc();

</script>
</body>
</html>